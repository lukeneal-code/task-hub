name: Integration Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  # Test database
  DATABASE_URL: postgresql://taskhub_test:test_secret@localhost:5434/taskhub_test
  # Test Keycloak
  KEYCLOAK_URL: http://localhost:8081
  KEYCLOAK_PUBLIC_URL: http://localhost:8081
  KEYCLOAK_ADMIN_USER: admin
  KEYCLOAK_ADMIN_PASSWORD: admin
  KEYCLOAK_CLIENT_ID: taskhub-app
  # API URLs
  API_URL: http://localhost:3002
  ADMIN_API_URL: http://localhost:8001
  FRONTEND_URL: http://localhost:3003

jobs:
  # Build all Docker images first
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build test images
        run: |
          docker compose -f docker-compose.test.yml build

  # Backend Integration Tests
  backend-integration:
    runs-on: ubuntu-latest
    needs: build
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: taskhub_test
          POSTGRES_PASSWORD: test_secret
          POSTGRES_DB: taskhub_test
        ports:
          - 5434:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install backend dependencies
        working-directory: backend
        run: npm install

      - name: Initialize database
        run: |
          PGPASSWORD=test_secret psql -h localhost -p 5434 -U taskhub_test -d taskhub_test -f scripts/test-seed.sql

      - name: Start Keycloak
        run: |
          docker run -d --name keycloak-test \
            -p 8081:8080 \
            -e KEYCLOAK_ADMIN=admin \
            -e KEYCLOAK_ADMIN_PASSWORD=admin \
            quay.io/keycloak/keycloak:23.0 start-dev

      - name: Wait for Keycloak
        run: |
          echo "Waiting for Keycloak to start..."
          for i in {1..60}; do
            if curl -s http://localhost:8081/health/ready | grep -q "UP"; then
              echo "Keycloak is ready!"
              break
            fi
            echo "Attempt $i/60..."
            sleep 5
          done

      - name: Setup Keycloak test realms
        run: |
          # Get admin token
          TOKEN=$(curl -s -X POST http://localhost:8081/realms/master/protocol/openid-connect/token \
            -d "grant_type=password" \
            -d "client_id=admin-cli" \
            -d "username=admin" \
            -d "password=admin" | jq -r '.access_token')

          # Create alpha realm
          curl -s -X POST http://localhost:8081/admin/realms \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"realm": "alpha", "enabled": true}'

          # Create taskhub-app client in alpha
          curl -s -X POST http://localhost:8081/admin/realms/alpha/clients \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"clientId": "taskhub-app", "publicClient": true, "directAccessGrantsEnabled": true, "redirectUris": ["*"]}'

          # Create roles in alpha
          for role in admin manager member; do
            curl -s -X POST http://localhost:8081/admin/realms/alpha/roles \
              -H "Authorization: Bearer $TOKEN" \
              -H "Content-Type: application/json" \
              -d "{\"name\": \"$role\"}"
          done

          # Create test users in alpha and assign roles
          for user_role in "admin:admin" "manager:manager" "member:member"; do
            IFS=':' read -r user role <<< "$user_role"
            # Create user
            curl -s -X POST http://localhost:8081/admin/realms/alpha/users \
              -H "Authorization: Bearer $TOKEN" \
              -H "Content-Type: application/json" \
              -d "{\"username\": \"${user}@alpha.com\", \"email\": \"${user}@alpha.com\", \"enabled\": true, \"emailVerified\": true, \"credentials\": [{\"type\": \"password\", \"value\": \"password123\", \"temporary\": false}]}"

            # Get user ID
            USER_ID=$(curl -s "http://localhost:8081/admin/realms/alpha/users?username=${user}@alpha.com" \
              -H "Authorization: Bearer $TOKEN" | jq -r '.[0].id')

            # Get role representation
            ROLE_REP=$(curl -s "http://localhost:8081/admin/realms/alpha/roles/${role}" \
              -H "Authorization: Bearer $TOKEN")

            # Assign role to user
            curl -s -X POST "http://localhost:8081/admin/realms/alpha/users/${USER_ID}/role-mappings/realm" \
              -H "Authorization: Bearer $TOKEN" \
              -H "Content-Type: application/json" \
              -d "[${ROLE_REP}]"
          done

          # Create beta realm
          curl -s -X POST http://localhost:8081/admin/realms \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"realm": "beta", "enabled": true}'

          # Create taskhub-app client in beta
          curl -s -X POST http://localhost:8081/admin/realms/beta/clients \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"clientId": "taskhub-app", "publicClient": true, "directAccessGrantsEnabled": true, "redirectUris": ["*"]}'

          # Create roles in beta
          for role in admin manager member; do
            curl -s -X POST http://localhost:8081/admin/realms/beta/roles \
              -H "Authorization: Bearer $TOKEN" \
              -H "Content-Type: application/json" \
              -d "{\"name\": \"$role\"}"
          done

          # Create test users in beta and assign roles
          for user_role in "admin:admin" "manager:manager" "member:member"; do
            IFS=':' read -r user role <<< "$user_role"
            # Create user
            curl -s -X POST http://localhost:8081/admin/realms/beta/users \
              -H "Authorization: Bearer $TOKEN" \
              -H "Content-Type: application/json" \
              -d "{\"username\": \"${user}@beta.com\", \"email\": \"${user}@beta.com\", \"enabled\": true, \"emailVerified\": true, \"credentials\": [{\"type\": \"password\", \"value\": \"password123\", \"temporary\": false}]}"

            # Get user ID
            USER_ID=$(curl -s "http://localhost:8081/admin/realms/beta/users?username=${user}@beta.com" \
              -H "Authorization: Bearer $TOKEN" | jq -r '.[0].id')

            # Get role representation
            ROLE_REP=$(curl -s "http://localhost:8081/admin/realms/beta/roles/${role}" \
              -H "Authorization: Bearer $TOKEN")

            # Assign role to user
            curl -s -X POST "http://localhost:8081/admin/realms/beta/users/${USER_ID}/role-mappings/realm" \
              -H "Authorization: Bearer $TOKEN" \
              -H "Content-Type: application/json" \
              -d "[${ROLE_REP}]"
          done

      - name: Run backend integration tests
        working-directory: backend
        run: npm run test:integration:ci
        env:
          DATABASE_URL: postgresql://taskhub_test:test_secret@localhost:5434/taskhub_test
          KEYCLOAK_URL: http://localhost:8081
          KEYCLOAK_PUBLIC_URL: http://localhost:8081

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: backend-coverage
          path: backend/coverage/

      - name: Cleanup
        if: always()
        run: docker stop keycloak-test || true

  # Admin Service Integration Tests
  admin-service-integration:
    runs-on: ubuntu-latest
    needs: build
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: taskhub_test
          POSTGRES_PASSWORD: test_secret
          POSTGRES_DB: taskhub_test
        ports:
          - 5434:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: admin-service/requirements-test.txt

      - name: Install admin service dependencies
        working-directory: admin-service
        run: pip install -r requirements-test.txt

      - name: Initialize database
        run: |
          PGPASSWORD=test_secret psql -h localhost -p 5434 -U taskhub_test -d taskhub_test -f scripts/test-seed.sql

      - name: Start Keycloak
        run: |
          docker run -d --name keycloak-test \
            -p 8081:8080 \
            -e KEYCLOAK_ADMIN=admin \
            -e KEYCLOAK_ADMIN_PASSWORD=admin \
            quay.io/keycloak/keycloak:23.0 start-dev

      - name: Wait for Keycloak
        run: |
          echo "Waiting for Keycloak to start..."
          for i in {1..60}; do
            if curl -s http://localhost:8081/health/ready | grep -q "UP"; then
              echo "Keycloak is ready!"
              break
            fi
            echo "Attempt $i/60..."
            sleep 5
          done

      - name: Start admin service
        working-directory: admin-service
        run: |
          uvicorn app.main:app --host 0.0.0.0 --port 8001 &
          sleep 10
        env:
          DATABASE_URL: postgresql://taskhub_test:test_secret@localhost:5434/taskhub_test
          KEYCLOAK_URL: http://localhost:8081
          KEYCLOAK_ADMIN_USER: admin
          KEYCLOAK_ADMIN_PASSWORD: admin

      - name: Wait for admin service
        run: |
          for i in {1..30}; do
            if curl -s http://localhost:8001/health | grep -q "ok"; then
              echo "Admin service is ready!"
              break
            fi
            echo "Attempt $i/30..."
            sleep 2
          done

      - name: Run admin service tests
        working-directory: admin-service
        run: pytest tests/integration -v --cov=app --cov-report=xml
        env:
          ADMIN_API_URL: http://localhost:8001
          DATABASE_URL: postgresql://taskhub_test:test_secret@localhost:5434/taskhub_test
          KEYCLOAK_URL: http://localhost:8081

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: admin-service-coverage
          path: admin-service/coverage.xml

      - name: Cleanup
        if: always()
        run: docker stop keycloak-test || true

  # E2E Smoke Tests
  e2e-smoke-tests:
    runs-on: ubuntu-latest
    needs: [backend-integration, admin-service-integration]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Start test infrastructure
        run: |
          docker compose -f docker-compose.test.yml up -d

      - name: Wait for services
        run: |
          echo "Waiting for all services to be healthy..."
          for i in {1..90}; do
            POSTGRES_OK=$(docker compose -f docker-compose.test.yml ps postgres-test | grep -c "healthy" || echo "0")
            KEYCLOAK_OK=$(docker compose -f docker-compose.test.yml ps keycloak-test | grep -c "healthy" || echo "0")
            BACKEND_OK=$(curl -s http://localhost:3002/health | grep -c "ok" || echo "0")
            ADMIN_OK=$(curl -s http://localhost:8001/health | grep -c "ok" || echo "0")

            if [ "$BACKEND_OK" = "1" ] && [ "$ADMIN_OK" = "1" ]; then
              echo "All services are ready!"
              break
            fi
            echo "Attempt $i/90 - Waiting for services..."
            sleep 10
          done

      - name: Seed test data
        run: |
          docker compose -f docker-compose.test.yml exec -T postgres-test psql -U taskhub_test -d taskhub_test -f /docker-entrypoint-initdb.d/test-seed.sql || true

      - name: Install E2E dependencies
        working-directory: e2e
        run: |
          npm install
          npx playwright install --with-deps chromium

      - name: Run E2E smoke tests
        working-directory: e2e
        run: npm test
        env:
          FRONTEND_URL: http://localhost:3003
          BACKEND_URL: http://localhost:3002
          ADMIN_API_URL: http://localhost:8001
          KEYCLOAK_URL: http://localhost:8081

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: e2e/playwright-report/

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: e2e-artifacts
          path: |
            e2e/test-results/

      - name: Cleanup
        if: always()
        run: docker compose -f docker-compose.test.yml down -v

  # Multi-Tenant Isolation Tests (Critical Security Tests)
  multi-tenant-isolation:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        working-directory: backend
        run: npm install

      - name: Start test infrastructure
        run: |
          docker compose -f docker-compose.test.yml up -d postgres-test keycloak-test backend-test

      - name: Wait for services
        run: |
          echo "Waiting for backend to be healthy..."
          for i in {1..60}; do
            if curl -s http://localhost:3002/health | grep -q "ok"; then
              echo "Backend is ready!"
              break
            fi
            echo "Attempt $i/60..."
            sleep 5
          done

      - name: Setup Keycloak test realms
        run: |
          # Wait for Keycloak
          for i in {1..60}; do
            if curl -s http://localhost:8081/health/ready | grep -q "UP"; then
              echo "Keycloak is ready!"
              break
            fi
            sleep 5
          done

          # Get admin token
          TOKEN=$(curl -s -X POST http://localhost:8081/realms/master/protocol/openid-connect/token \
            -d "grant_type=password" \
            -d "client_id=admin-cli" \
            -d "username=admin" \
            -d "password=admin" | jq -r '.access_token')

          # Setup realms
          for realm in alpha beta; do
            curl -s -X POST http://localhost:8081/admin/realms \
              -H "Authorization: Bearer $TOKEN" \
              -H "Content-Type: application/json" \
              -d "{\"realm\": \"$realm\", \"enabled\": true}"

            curl -s -X POST "http://localhost:8081/admin/realms/$realm/clients" \
              -H "Authorization: Bearer $TOKEN" \
              -H "Content-Type: application/json" \
              -d '{"clientId": "taskhub-app", "publicClient": true, "directAccessGrantsEnabled": true, "redirectUris": ["*"]}'

            for role in admin manager member; do
              curl -s -X POST "http://localhost:8081/admin/realms/$realm/roles" \
                -H "Authorization: Bearer $TOKEN" \
                -H "Content-Type: application/json" \
                -d "{\"name\": \"$role\"}"
            done

            # Create test users and assign roles
            for user_role in "admin:admin" "manager:manager" "member:member"; do
              IFS=':' read -r user role <<< "$user_role"
              # Create user
              curl -s -X POST "http://localhost:8081/admin/realms/$realm/users" \
                -H "Authorization: Bearer $TOKEN" \
                -H "Content-Type: application/json" \
                -d "{\"username\": \"${user}@${realm}.com\", \"email\": \"${user}@${realm}.com\", \"enabled\": true, \"emailVerified\": true, \"credentials\": [{\"type\": \"password\", \"value\": \"password123\", \"temporary\": false}]}"

              # Get user ID
              USER_ID=$(curl -s "http://localhost:8081/admin/realms/$realm/users?username=${user}@${realm}.com" \
                -H "Authorization: Bearer $TOKEN" | jq -r '.[0].id')

              # Get role representation
              ROLE_REP=$(curl -s "http://localhost:8081/admin/realms/$realm/roles/${role}" \
                -H "Authorization: Bearer $TOKEN")

              # Assign role to user
              curl -s -X POST "http://localhost:8081/admin/realms/$realm/users/${USER_ID}/role-mappings/realm" \
                -H "Authorization: Bearer $TOKEN" \
                -H "Content-Type: application/json" \
                -d "[${ROLE_REP}]"
            done
          done

      - name: Run isolation tests
        working-directory: backend
        run: |
          npm run test:integration:ci -- --testPathPattern=isolation
        env:
          API_URL: http://localhost:3002
          KEYCLOAK_URL: http://localhost:8081
          KEYCLOAK_PUBLIC_URL: http://localhost:8081

      - name: Cleanup
        if: always()
        run: docker compose -f docker-compose.test.yml down -v

  # Summary job
  test-summary:
    runs-on: ubuntu-latest
    needs: [backend-integration, admin-service-integration, e2e-smoke-tests, multi-tenant-isolation]
    if: always()

    steps:
      - name: Check test results
        run: |
          echo "Backend Integration: ${{ needs.backend-integration.result }}"
          echo "Admin Service Integration: ${{ needs.admin-service-integration.result }}"
          echo "E2E Smoke Tests: ${{ needs.e2e-smoke-tests.result }}"
          echo "Multi-Tenant Isolation: ${{ needs.multi-tenant-isolation.result }}"

          if [ "${{ needs.backend-integration.result }}" != "success" ] || \
             [ "${{ needs.admin-service-integration.result }}" != "success" ] || \
             [ "${{ needs.e2e-smoke-tests.result }}" != "success" ] || \
             [ "${{ needs.multi-tenant-isolation.result }}" != "success" ]; then
            echo "One or more test suites failed!"
            exit 1
          fi

          echo "All tests passed!"
